<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml"
      xmlns:th="http://www.thymeleaf.org"
      xmlns:sec="http://www.thymeleaf.org/thymeleaf-extras-springsecurity6">

    <body>
        <!-- Fragmento AGREGAR (Modal para nuevo elemento) -->
        <section th:fragment="agregar">
            <div class="row py-4 mb-2 bg-light">
                <div class="col-md-1"></div>
                <div class="col-md-3">
                    <button type="button" class="btn btn-primary"
                            data-bs-toggle="modal" data-bs-target="#agregarReposteriaModal">
                        <i class="fa-solid fa-plus"></i> Agregar Repostería
                    </button>
                </div>
            </div>

            <!-- Modal -->
            <div class="modal fade" id="agregarReposteriaModal" tabindex="-1" aria-labelledby="modalLabel" aria-hidden="true">
                <div class="modal-dialog">
                    <div class="modal-content">
                        <div class="modal-header bg-info text-white">
                            <h1 class="modal-title fs-5"><i class="fa-solid fa-cookie-bite"></i> Agregar Repostería/Café</h1>
                            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                        </div>
                        <form th:action="@{/reposteria/guardar}" method="post" class="was-validated" enctype="multipart/form-data">
                            <div class="modal-body">
                                <!-- Campo oculto para ID (vacío para nuevo elemento) -->
                                <input type="hidden" name="id_listadoReposteriaCafe" value=""/>

                                <div class="mb-3">
                                    <label>Descripción</label>
                                    <input type="text" name="descripcion" class="form-control" maxlength="100" required/>
                                </div>
                                <div class="mb-3">
                                    <label>Precio</label>
                                    <input type="number" name="precio" class="form-control" step="0.01" min="0" required/>
                                </div>
                                <div class="mb-3">
                                    <label>Disponible</label>
                                    <select name="disponible" class="form-control" required>
                                        <option value="true">Sí</option>
                                        <option value="false">No</option>
                                    </select>
                                </div>
                                <div class="mb-3">
                                    <label>Imagen</label>
                                    <input type="file" name="imagenFile" onchange="mostrarImagen(this, 'blahReposteria');" class="form-control"/>
                                    <img id="blahReposteria" src="#" alt="Imagen del producto" height="200"/>
                                </div>
                            </div>
                            <div class="modal-footer">
                                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                                    <i class="fa-solid fa-xmark"></i> Cerrar
                                </button>
                                <button type="submit" class="btn btn-primary">
                                    <i class="fa-solid fa-floppy-disk"></i> Guardar
                                </button>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
        </section>

        <!-- Fragmento LISTADO -->
        <section th:fragment="listado" class="p-3">
            <div class="row p-3">
                <!-- Tabla de repostería -->
                <div class="col-md-9">
                    <div class="card shadow-sm">
                        <div class="card-header bg-info text-white">
                            <h4 class="mb-0"><i class="fa-solid fa-cookie-bite"></i> Listado de Repostería y Café</h4>
                        </div>
                        <div class="card-body">
                            <div th:if="${reposterias != null and !reposterias.empty}">
                                <table class="table table-striped table-hover align-middle text-center">
                                    <thead class="table-dark">
                                        <tr>
                                            <th>#</th>
                                            <th>Descripción</th>
                                            <th>Precio</th>
                                            <th>Disponible</th>
                                            <th>Imagen</th>
                                            <th class="text-end">Acciones</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <tr th:each="r : ${reposterias}">
                                            <td>[[${r.id_listadoReposteriaCafe}]]</td>
                                            <td>[[${r.descripcion}]]</td>
                                            <td>$[[${#numbers.formatDecimal(r.precio, 1, 2)}]]</td>
                                            <td>
                                                <span th:if="${r.disponible}" class="badge bg-success">Sí</span>
                                                <span th:unless="${r.disponible}" class="badge bg-danger">No</span>
                                            </td>
                                            <td>
                                                <img th:if="${r.imagen}" th:src="@{${r.imagen}}" alt="Imagen repostería"
                                                     class="border rounded"
                                                     style="height:65px; width:65px; object-fit:cover;">
                                                    <span th:unless="${r.imagen}" class="text-muted">Sin imagen</span>
                                            </td>
                                            <td class="text-end">
                                                <a th:href="@{/reposteria/modificar/}+${r.id_listadoReposteriaCafe}" 
                                                   class="btn btn-warning btn-sm me-1">
                                                    <i class="fas fa-pencil-alt"></i> Actualizar
                                                </a>
                                                <button type="button" class="btn btn-danger btn-sm"
                                                        data-bs-toggle="modal" data-bs-target="#confirmModalReposteria"
                                                        th:attr="data-bs-id=${r.id_listadoReposteriaCafe}, data-bs-descripcion=${r.descripcion}">
                                                    <i class="fa-solid fa-trash"></i> Eliminar
                                                </button>
                                            </td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>

                            <!-- Si no hay elementos -->
                            <div class="text-center text-muted p-4"
                                 th:if="${reposterias == null or reposterias.empty}">
                                <p class="mb-0"><i class="fa-regular fa-circle-xmark"></i> No hay elementos registrados.</p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Tarjeta con total -->
                <div class="col-md-3">
                    <div class="card text-center bg-success text-white mb-3 shadow-sm">
                        <div class="card-body">
                            <h5>Total de Repostería</h5>
                            <h4 class="fs-2">
                                <i class="fas fa-cookie-bite"></i>
                                <span th:text="${reposterias != null ? #lists.size(reposterias) : 0}">0</span>
                            </h4>
                        </div>
                    </div>
                </div>
            </div>
        </section>

        <!-- Fragmento MODIFICA -->
        <section th:fragment="modifica">
            <div class="row">
                <div class="col-md-2"></div>
                <div class="col-md-8">
                    <form method="POST" th:action="@{/reposteria/guardar}" class="was-validated" enctype="multipart/form-data">
                        <!-- Campos ocultos para ID e imagen existente -->
                        <input type="hidden" name="id_listadoReposteriaCafe" th:value="${reposteria.id_listadoReposteriaCafe}"/>
                        <input type="hidden" name="imagen" th:value="${reposteria.imagen}"/>

                        <div class="row py-4 mb-4 bg-light">
                            <div class="col-md-4 d-grid">
                                <a th:href="@{/reposteria/listado}" class="btn btn-primary">
                                    <i class="fas fa-arrow-left"></i> Regresar
                                </a>
                            </div>
                            <div class="col-md-4 d-grid">
                                <button type="submit" class="btn btn-success">
                                    <i class="fas fa-check"></i> Guardar
                                </button>
                            </div>
                        </div>

                        <div class="row">
                            <div class="col">
                                <div class="card">
                                    <div class="card-header bg-secondary text-white">
                                        <h4><i class="fas fa-edit"></i> Actualizar Repostería/Café</h4>
                                    </div>
                                    <div class="card-body">
                                        <div class="mb-3">
                                            <label for="descripcion">Descripción</label>
                                            <input type="text" class="form-control" id="descripcion" name="descripcion"
                                                   th:value="${reposteria.descripcion}" maxlength="100" required="true"/>
                                        </div>

                                        <div class="mb-3">
                                            <label for="precio">Precio</label>
                                            <input type="number" class="form-control" id="precio" name="precio"
                                                   th:value="${reposteria.precio}" step="0.01" min="0" required="true"/>
                                        </div>

                                        <div class="mb-3">
                                            <label for="disponible">Disponible</label>
                                            <select class="form-control" id="disponible" name="disponible" required="true">
                                                <option value="true" th:selected="${reposteria.disponible == true}">Sí</option>
                                                <option value="false" th:selected="${reposteria.disponible == false}">No</option>
                                            </select>
                                        </div>

                                        <div class="mb-3">
                                            <label for="imagenFile">Imagen</label>
                                            <input class="form-control" type="file" id="imagenFile" name="imagenFile"
                                                   onchange="mostrarImagen(this, 'blahModifica');" />
                                            <img id="blahModifica" th:src="@{${reposteria.imagen}}" alt="Imagen del producto" height="200"/>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </form>
                </div>
            </div>
        </section>

        <!-- Fragmento CONFIRMAR ELIMINAR -->
        <section th:fragment="confirmarEliminar">
            <div class="modal fade" id="confirmModalReposteria" tabindex="-1" aria-labelledby="modalLabel" aria-hidden="true">
                <div class="modal-dialog modal-dialog-centered">
                    <div class="modal-content">
                        <form th:action="@{/reposteria/eliminar}" method="post" id="eliminarFormReposteria">
                            <input type="hidden" name="id_listadoReposteriaCafe" id="modalIdReposteria" value=""/>
                            <div class="modal-header bg-warning text-white">
                                <h5 class="modal-title" id="modalLabelReposteria">
                                    <i class="fa-solid fa-circle-radiation"></i> Confirmar Eliminación
                                </h5>
                                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Cerrar"></button>
                            </div>
                            <div class="modal-body">
                                <p>¿Está seguro que desea eliminar <span id="modalDescripcionReposteria"></span>?</p>
                                <h6>Esta acción no se puede deshacer.</h6>
                            </div>
                            <div class="modal-footer">
                                <button type="submit" class="btn btn-danger">
                                    <i class="fa-solid fa-trash"></i> Eliminar
                                </button>
                                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                                    <i class="fa-solid fa-xmark"></i> Cerrar
                                </button>
                            </div>
                        </form>
                    </div>
                </div>
            </div>

            <!-- Script para manejar el modal de eliminación -->
            <script>
                document.addEventListener('DOMContentLoaded', function () {
                    var confirmModal = document.getElementById('confirmModalReposteria');

                    confirmModal.addEventListener('show.bs.modal', function (event) {
                        var button = event.relatedTarget;
                        var id = button.getAttribute('th:data-bs-id');
                        var descripcion = button.getAttribute('th:data-bs-descripcion');

                        if (!id) {
                            id = button.getAttribute('data-bs-id');
                        }
                        if (!descripcion) {
                            descripcion = button.getAttribute('data-bs-descripcion');
                        }

                        var modalIdInput = document.getElementById('modalIdReposteria');
                        var modalDescripcionSpan = document.getElementById('modalDescripcionReposteria');

                        if (modalIdInput) {
                            modalIdInput.value = id;
                        }
                        if (modalDescripcionSpan) {
                            modalDescripcionSpan.textContent = descripcion;
                        }
                    });
                });
            </script>
        </section>

        <!-- Script para mostrar imagen preview -->
        <script>
            function mostrarImagen(input, imgId) {
                if (input.files && input.files[0]) {
                    var reader = new FileReader();
                    reader.onload = function (e) {
                        document.getElementById(imgId).src = e.target.result;
                    };
                    reader.readAsDataURL(input.files[0]);
                }
            }
        </script>
    </body>
</html>
